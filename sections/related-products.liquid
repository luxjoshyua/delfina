{% for tag in product.tags %}
	{% if tag contains "_type" %}
		{% assign current_type = tag %}
	{% endif %}
{% endfor %}

{% if collection.products_count > 1 %}

  {% case section.settings.grid %}
    {% when 2 %}
      {%- assign max_height = 530 -%}
    {% when 3 %}
      {%- assign max_height = 345 -%}
    {% when 4 %}
      {%- assign max_height = 250 -%}
    {% when 5 %}
      {%- assign max_height = 195 -%}
  {% endcase %}

  {% if section.settings.layout == 'grid' %}
    {%- assign limit = 3 -%}
  {% else %}
    {%- assign limit = 16 -%}
  {% endif %}
	
  {% assign collection = collection.handle %}
  {% assign current_product = product.id %}

<div class="page-width">
  
    {% if section.settings.title != blank %}
      <div class="section-header text-center">
        <h2>{{ section.settings.title | escape }}</h2>
      </div>
    {% endif %}
    
    <div class="grid grid--uniform">
      <div class="grid__item medium-up--five-sixths medium-up--push-one-twelfth">
          {% if section.settings.layout == 'grid' %}
            {% case section.settings.grid %}
            {% when 2 %}
              {%- assign grid_item_width = 'medium-up--one-half' -%}
            {% when 3 %}
              {%- assign grid_item_width = 'small--one-half medium-up--one-third' -%}
            {% when 4 %}
              {%- assign grid_item_width = 'small--one-half medium-up--one-quarter' -%}
            {% when 5 %}
              {%- assign grid_item_width = 'small--one-half medium-up--one-fifth' -%}
            {% endcase %}


            <ul class="grid grid--uniform{% if collection.products_count > 0 %} grid--view-items{% endif %}">
              {% assign related_limit = 0 %}
              {% for product in collections[collection].products %}
                {% for tag in product.tags %}
              	  {% unless related_limit == limit %}
                  {% if tag == current_type %}
                      {% unless product.id == current_product %}
                      <li class="grid__item grid__item--{{section.id}} {{ grid_item_width }} text-center">
                        {% include 'product-card-grid', max_height: max_height %}
                      </li>
                      {% endunless %}
              		  {% assign related_limit = related_limit | plus: 1 %}
              	   {% endif %}
              	  {% endunless %}
              	{% endfor %}
              {% endfor %}
            </ul>
          {% else %}
            <ul class="list-view-items">
              {% for product in collection.products limit: limit %}
                {% unless product.id == current_product %}
                  <li class="list-view-item">
                    {% include 'product-card-list', product: product %}
                  </li>
                {% endunless %}
              {% endfor %}
            </ul>
          {% endif %}
      </div>
    </div>
  </div>

{% endif %}


{% schema %}
  {
    "name": "Related products",
	"class": "section__related-products",
    "settings": [
    {
      "type": "select",
      "id": "layout",
      "label": {
        "de": "Layout",
        "en": "Layout",
        "es": "Diseño",
        "fr": "Mise en page",
        "it": "Layout",
        "ja": "レイアウト",
        "pt-BR": "Layout"
      },
      "default": "grid",
      "options": [
        {
          "value": "grid",
          "label": {
            "de": "Raster",
            "en": "Grid",
            "es": "Cuadrícula",
            "fr": "Grille",
            "it": "Griglia",
            "ja": "グリッド",
            "pt-BR": "Grade"
          }
        },
        {
          "value": "list",
          "label": {
            "de": "Liste",
            "en": "List",
            "es": "Lista",
            "fr": "Liste",
            "it": "Elenco",
            "ja": "リスト",
            "pt-BR": "Lista"
          }
        }
      ]
    },
    {
      "type": "range",
      "id": "grid",
      "label": {
        "de": "Produkte per Reihe (nur Raster)",
        "en": "Products per row (grid only)",
        "es": "Productos por fila (solo cuadrícula)",
        "fr": "Produits par rangée (grille uniquement)",
        "it": "Prodotti per riga (solo griglia)",
        "ja": "行あたりの商品数（グリッドのみ）",
        "pt-BR": "Produtos por linha (somente grade)"
      },
      "default": 4,
      "min": 2,
      "max": 5,
      "step": 1
    },
	{
      "type": "text",
      "id": "title",
      "label": {
        "de": "Titel",
        "en": "Heading",
        "es": "Título",
        "fr": "En-tête",
        "it": "Heading",
        "ja": "見出し",
        "pt-BR": "Título"
      },
      "default": {
        "de": "Textspalten mit Fotos",
        "en": "Text columns with images",
        "es": "Col. de texto con imagen",
        "fr": "Colonnes de texte avec images",
        "it": "Colonne di testo con foto",
        "ja": "画像付きテキスト列",
        "pt-BR": "Colunas de texto com imagens"
      }
    }
  ]
}
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
{% endjavascript %}
